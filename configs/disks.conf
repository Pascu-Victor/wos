#!/bin/bash
# configs/disks.conf - Disk-to-mountpoint configuration
# Source this file from build scripts.
#
# Format: "DISK_IMAGE:PARTITION_NUM  MOUNTPOINT  FSTYPE"
# PARTUUIDs are auto-extracted from disk images at build time.
# Add or remove entries to configure which filesystems init mounts.

DISK_ENTRIES=(
    "disk.qcow2:1         /boot       fat32"
    "test_fat32.qcow2:1   /mnt/disk   fat32"
)

# Extract PARTUUID from a disk image and partition number
extract_partuuid() {
    local disk_image="$1"
    local part_num="$2"
    guestfish --ro -a "$disk_image" -- \
        run : part-get-gpt-guid /dev/sda "$part_num" 2>/dev/null \
        | tr '[:upper:]' '[:lower:]'
}

# Generate fstab from DISK_ENTRIES
generate_fstab() {
    local fstab_path="$1"
    {
        echo "# /etc/fstab - Auto-generated by make_initramfs.sh"
        echo "# <device>                                       <mountpoint>  <fstype>  <options>"
        echo ""
    } > "$fstab_path"

    for entry in "${DISK_ENTRIES[@]}"; do
        local disk_part
        local mountpoint
        local fstype
        disk_part=$(echo "$entry" | awk '{print $1}')
        mountpoint=$(echo "$entry" | awk '{print $2}')
        fstype=$(echo "$entry" | awk '{print $3}')

        local disk_image
        local part_num
        disk_image=$(echo "$disk_part" | cut -d: -f1)
        part_num=$(echo "$disk_part" | cut -d: -f2)

        if [ ! -f "$disk_image" ]; then
            echo "WARNING: Disk image '$disk_image' not found, skipping" >&2
            continue
        fi

        local partuuid
        partuuid=$(extract_partuuid "$disk_image" "$part_num")
        if [ -z "$partuuid" ]; then
            echo "WARNING: Could not extract PARTUUID from $disk_image partition $part_num" >&2
            continue
        fi

        printf "PARTUUID=%-36s  %-12s  %-8s  defaults\n" \
            "$partuuid" "$mountpoint" "$fstype" >> "$fstab_path"
        echo "  fstab: PARTUUID=$partuuid -> $mountpoint ($fstype)"
    done
}
